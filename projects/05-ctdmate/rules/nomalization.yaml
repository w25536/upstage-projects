meta:
  name: "CTDMate Normalization Map (M1~M2 + M2.6)"
  version: "0.7.1"
  date: "2025-10-01"

# 처리 순서. 앞에서 깨끗해질수록 뒤 단계 충돌 감소.
# 조정 영향: 순서를 바꾸면 예컨대 regex_subs가 maps보다 먼저 실행되어
#            매핑 대상이 달라질 수 있음(정확성/일관성 변화).
apply_order:
  - "trim"
  - "unicode_nfkc"
  - "whitespace_dedupe"
  - "case_maps"
  - "aliases"
  - "maps"
  - "regex_subs"
  - "units"
  - "number_format"

# 대/소문자 정책. value는 "lower","upper","capitalize","preserve" 중 선택.
# 조정 영향: 전체 소문자화하면 매핑 단순화(매칭률↑) 되지만 원문 충실도↓.
case_maps:
  DosageForm: lower
  Route: lower
  Species: capitalize
  Sex: lower
  StudyType: lower
  default: preserve

# CSV 헤더나 비정형 필드의 여러 표기(동의어)를 표준 키로 매핑.
# 조정 영향: alias 추가로 입력 파싱 실패 감소. 너무 많은 alias는 충돌 유발 가능.
aliases:
  "Study Id": "StudyID"
  "study_id": "StudyID"
  "Species/Strain": "Species"
  "Sex/Gender": "Sex"
  "Route of Admin": "Route"
  "RouteOfAdministration": "Route"
  "Dosing Regimen": "DoseRegimen"
  "Dose Regimen": "DoseRegimen"
  "Duration (wk)": "Duration"
  "Exposure/TK": "TK_PKC"
  "Key Findings": "KeyFindings"
  "GLP Compliant": "GLP"

# 직접 매핑 사전. 소스→표준값.
# 조정 영향: maps에 폭넓은 동의어를 넣으면 정규화 정확도↑.
maps:
  dosage_form:
    "tabs": "tablet"
    "tablet.": "tablet"
    "film coated tablet": "film-coated tablet"
    "fc tablet": "film-coated tablet"
    "cap": "capsule"
    "caps": "capsule"
    "oral solution": "solution"
    "oph solution": "ophthalmic solution"
    "ophthalmic sol.": "ophthalmic solution"
    "oph suspension": "ophthalmic suspension"

  species:
    "rat": "Rat"
    "랫드": "Rat"
    "mouse": "Mouse"
    "마우스": "Mouse"
    "rabbit": "Rabbit"
    "dog": "Dog"
    "beagle": "Dog"
    "monkey": "Monkey"
    "cynomolgus": "Cynomolgus monkey"
    "cynomolgus monkey": "Cynomolgus monkey"

  sex:
    "m": "male"
    "f": "female"
    "남": "male"
    "여": "female"

  route:
    "po": "oral"
    "per os": "oral"
    "p.o.": "oral"
    "iv": "intravenous"
    "i.v.": "intravenous"
    "im": "intramuscular"
    "sc": "subcutaneous"
    "s.c.": "subcutaneous"
    "oph": "ophthalmic"
    "ocular": "ophthalmic"
    "dermal": "dermal"

  study_type:
    "acute": "single-dose"
    "single": "single-dose"
    "subacute": "repeat-dose"
    "subchronic": "repeat-dose"
    "repeated": "repeat-dose"
    "geno": "genotoxicity"
    "genotox": "genotoxicity"
    "carcinog": "carcinogenicity"
    "repro": "reproductive"
    "fertility": "reproductive"
    "dev": "developmental"
    "safety pharm": "safety pharmacology"
    "local tol": "local tolerance"

  dose_unit:
    "mg/kg/d": "mg/kg/day"
    "mg/kg bw/day": "mg/kg/day"

  duration:
    "14 d": "14 d"
    "28 d": "28 d"
    "13 w": "13 wk"
    "26 w": "26 wk"
    "hr": "h"
    "hours": "h"
    "day": "d"
    "days": "d"
    "week": "wk"
    "weeks": "wk"
    "wks": "wk"
    "w": "wk"

  glp:
    "y": "yes"
    "yes": "yes"
    "n": "no"
    "no": "no"
    "가능": "yes"
    "아님": "no"

# 정규표현식 치환 목록(순서대로 적용).
# 조정 영향: regex가 maps보다 앞서면 maps 매칭 대상이 변경됨.
regex_subs:
  - pattern: "\\s{2,}"
    replace: " "
    # 설명: 연속 공백을 단일 공백으로. 너무 강하게 하면 의도치 않은 합침 발생.
  - pattern: "–|—"
    replace: "-"
    # 설명: 대시 통일
  - pattern: "\\bfilm coated\\b"
    replace: "film-coated"
  - pattern: "(?i)milligram(s)?"
    replace: "mg"
  - pattern: "(?i)mil(li)?liter(s)?"
    replace: "mL"
  - pattern: "(?i)percent( w/w)?"
    replace: "w/w %"
  - pattern: "(?i)percent( w/v)?"
    replace: "w/v %"
  - pattern: "(?i)mg/kg/d(ay)?"
    replace: "mg/kg/day"

# 단위 정책
# enforce: true 이면 whitelist에 없는 단위는 오류/경고로 처리
# 조정 영향: enforce=false면 입력 보존, 검토자 부담↑
units:
  enforce: true
  whitelist:
    - "mg"
    - "g"
    - "µg"
    - "mL"
    - "L"
    - "w/w %"
    - "w/v %"
    - "°C"
    - "mg/kg/day"
    - "h"
    - "d"
    - "wk"
  coerce_rules:
    - pattern: "(?i)hours?"
      to: "h"
      # 설명: "hours","hrs" → "h"
    - pattern: "(?i)days?"
      to: "d"
    - pattern: "(?i)weeks?|wks?"
      to: "wk"

# 숫자 형식 규칙
# strip_trailing_zeros: true이면 1.500 → 1.5. (원문충실도↓, 일관성↑)
# max_decimals: 반올림 자릿수. ↑이면 정밀도↑ 토큰비용↑
number_format:
  decimal_separator: "."
  strip_trailing_zeros: true
  max_decimals: 3

# 예시/주의: 아래 설정을 통해 파이프라인 동작을 이해하라.
# - maps 항목을 확장하면 정규화 정확도 증가. 단 너무 많으면 유지보수 비용 상승.
# - regex_subs는 범용 치환을 먼저 적용하고 maps로 세밀 매핑하는 것이 안전.
# - units.enforce=True는 품질 검증 강화용. 시연용 데모에서는 False 권장.
